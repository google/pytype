add_package()

genflex(
  NAME
    lexer
  SRC
    lexer.lex
  CC_OUT
    lexer.lex.cc
  BISON_DEP
    .parser_gen
)

genbison(
  NAME
    parser_gen
  SRC
    parser.yy
  HDR_OUT
    parser.tab.hh
  CC_OUT
    parser.tab.cc
)

py_extension(
  NAME
    parser_ext
  SRCS
    parser_ext.cc
    $<TARGET_PROPERTY:pytype.pyi.lexer,CC_OUT>
    $<TARGET_PROPERTY:pytype.pyi.parser_gen,CC_OUT>
    $<TARGET_PROPERTY:pytype.pyi.parser_gen,HDR_OUT>
  DEPS
    .parser_gen
    .lexer
)

py_library(
  NAME
    parser
  SRCS
    parser.py
  DEPS
    .parser_ext
    pytype.utils
    pytype.pytd.pytd_for_parser
)

py_test(
  NAME
    lexer_test
  SRCS
    lexer_test.py
  DEPS
    .parser_ext
    pytype.pytd.builtins_pytd
    pytype.pytd.parse.parser_constants
    pytype.tests.test_base
)

py_test(
  NAME
    parser_test
  SRCS
    parser_test.py
  DEPS
    .parser
    pytype.pytd.builtins_pytd
    pytype.pytd.pytd_defs
    pytype.pytd.pytd_utils
    pytype.tests.test_base
)

py_test(
  NAME
    parser_memleak_test
  SRCS
    parser_memleak_test.py
  DEPS
    .parser
    pytype.pytd.builtins_pytd
    pytype.tests.test_base
)
